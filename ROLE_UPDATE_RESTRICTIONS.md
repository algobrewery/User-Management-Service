# Role Update Field Restrictions

## Overview

This document outlines which role attributes can and cannot be updated to maintain system integrity and prevent breaking changes.

## ✅ **ALLOWED to Update**

### 1. **Description**
- **Field**: `description`
- **Type**: `String` (max 255 characters)
- **Reason**: Safe to change, provides context about role purpose
- **Example**: "Updated role description for better clarity"

### 2. **Policy**
- **Field**: `policy`
- **Type**: `JsonNode` (JSON object)
- **Reason**: Core functionality - defines permissions and features
- **Example**: 
```json
{
  "data": {
    "read": ["users", "roles", "organization"],
    "write": ["users", "tasks"],
    "delete": ["tasks"]
  },
  "features": {
    "execute": ["view_reports", "create_task", "assign_tasks"]
  }
}
```

### 3. **Active Status**
- **Field**: `is_active`
- **Type**: `Boolean`
- **Reason**: Operational control - enables/disables role
- **Example**: `true` or `false`

## ❌ **NOT ALLOWED to Update**

### 1. **Role Name**
- **Field**: `role_name`
- **Reason**: Unique identifier used throughout the system
- **Impact if Changed**: Breaks role references, user assignments, permission checks

### 2. **Role UUID**
- **Field**: `role_uuid`
- **Reason**: System-generated primary key
- **Impact if Changed**: Breaks all relationships, database integrity

### 3. **Organization UUID**
- **Field**: `organization_uuid`
- **Reason**: Defines ownership boundary and security scope
- **Impact if Changed**: Security risk, data integrity violation

### 4. **Role Management Type**
- **Field**: `role_management_type`
- **Reason**: Defines whether role is SYSTEM_MANAGED or CUSTOMER_MANAGED
- **Impact if Changed**: Changes role scope and permission model

### 5. **Created At**
- **Field**: `created_at`
- **Reason**: Audit trail timestamp
- **Impact if Changed**: Breaks audit history and compliance

### 6. **Created By**
- **Field**: `created_by`
- **Reason**: Audit trail - tracks who created the role
- **Impact if Changed**: Breaks audit history and accountability

### 7. **Updated At**
- **Field**: `updated_at`
- **Reason**: System-managed timestamp
- **Impact if Changed**: Auto-generated by system, manual changes break logic

## Implementation Details

### New UpdateRoleRequest Model

```java
@Data
@Builder
public class UpdateRoleRequest {
    @Size(max = 255)
    private String description;
    
    private JsonNode policy;
    
    private Boolean is_active;
}
```

### Update Process Flow

1. **Receive UpdateRoleRequest** - Only contains updatable fields
2. **Fetch Current Role** - Get existing role data from external service
3. **Map to CreateRoleRequest** - Combine current data with updates
4. **Preserve Immutable Fields** - Keep role_name, organization_uuid, etc.
5. **Send to External Service** - Use standard CreateRoleRequest format
6. **Handle is_active** - Apply separately if provided

### API Usage

```http
PUT /role/{roleUuid}
Content-Type: application/json
x-app-org-uuid: your-org-uuid
x-app-user-uuid: your-user-uuid

{
  "description": "Updated role description",
  "policy": {
    "data": {
      "read": ["users", "roles"],
      "write": ["users"]
    },
    "features": {
      "execute": ["view_reports"]
    }
  },
  "is_active": true
}
```

## Security Considerations

1. **Immutable Identifiers**: Role name and UUID cannot be changed to prevent confusion and maintain referential integrity
2. **Ownership Boundaries**: Organization UUID cannot be changed to prevent privilege escalation
3. **Audit Trail**: Creation metadata cannot be modified to maintain compliance
4. **System Integrity**: Management type cannot be changed to prevent scope confusion

## Migration Notes

- **Backward Compatibility**: Existing `CreateRoleRequest` is still used for role creation
- **New Model**: `UpdateRoleRequest` is used only for updates with restricted fields
- **Validation**: All restricted fields are excluded from the update request model
- **Error Handling**: Attempts to update restricted fields will be rejected by the API

## Testing

### Valid Update Scenarios
- ✅ Update description only
- ✅ Update policy only  
- ✅ Update is_active only
- ✅ Update multiple allowed fields

### Invalid Update Scenarios
- ❌ Attempt to update role_name
- ❌ Attempt to update role_uuid
- ❌ Attempt to update organization_uuid
- ❌ Attempt to update role_management_type
- ❌ Attempt to update created_at/created_by

## Best Practices

1. **Always validate** that only allowed fields are being updated
2. **Log all updates** for audit purposes
3. **Use partial updates** - only send fields that need to be changed
4. **Test thoroughly** to ensure restricted fields cannot be modified
5. **Document changes** in role descriptions when updating policies
